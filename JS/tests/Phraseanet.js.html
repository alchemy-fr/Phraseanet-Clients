<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="../../vendor/qunit/qunit/qunit.js"></script>
    <script src="../Phraseanet.js"></script>
    <script src="../cookie.js"></script>
    <script src="../auth.js"></script>
    <script src="../api.js"></script>
    <script src="../queryformater.js"></script>    
    <link type="text/css" rel="stylesheet" href="../../vendor/qunit/qunit/qunit.css"/> 
    <script>  
      jQuery(document).ready(function(){
    
      module("Phraseanet instanciation");
      
      
      test("Phraseanet instanciation", function() {
        var phrasea = new Phraseanet({
        	apiKey: "1234567890",
        	domain: "http://sub.domain.tld"
        });
        
        var session = new Object();

        equal( '0.1', phrasea.getVersion(), "Version is 0.1" );
        equal( '1234567890', phrasea._apiKey, "Api key equals 1234567890" );
        equal( 'http://sub.domain.tld', phrasea._domain.www, "Instance equals http://sub.domain.tld" );
        deepEqual( session, phrasea.getSession() , "session is empty object")
        
        
		raises(function() {
    		var instance = new Phraseanet();
  		}, "must throw exception to pass");        
      });


      module("Phraseanet query formater");


		test("test encode", function() {
			var phrasea = new Phraseanet({
        		apiKey: "1234567890",
        		domain: "http://sub.domain.tld"
        	});
		
			
			var str = phrasea._query_formater.encode();
  			equal("",str, "str is an empty string");
  			
  			var str = phrasea._query_formater.encode({
				"key?:" : " /?:<>&"
			});
  			equal("key%3F%3A=%20%2F%3F%3A%3C%3E%26", str, "parameters are encoded");
		});
	
		test("test decode", function() {
		
			var phrasea = new Phraseanet({
				apiKey: "2345663",
				domain: "http:// totoenshort.com"
			});
			
			var titi = phrasea._query_formater.decode("");
			deepEqual(titi, new Object());
			
			var phrasea = new Phraseanet({
				apiKey: "2345663",
				domain: "http:// totoenshort.com"
			});
			
			var titi = phrasea._query_formater.decode("test");
			deepEqual( titi, {"test" : ""});
			
			var toto = phrasea._query_formater.decode("access_token=FJQbwq9&expires_in=3600");
			var expected = {
				access_token: "FJQbwq9",
				expires_in: "3600"
			};
			
			deepEqual(expected, toto);
	
		});
	

		module("Gestion des cookies");
		
		test("Test cookie", function() {
			var phrasea = new Phraseanet({
				apiKey: "2345663",
				domain: "http://my.domain.tld"
		});
			
		
		var session = {
			access_token:'toto'
		};
		
		phrasea.setSession(session);
		
		var cookie = new Cookie(phrasea);
		
		// Test instanciation objet Cookie
		deepEqual(cookie._phraseanet._apiKey, "2345663", "Instanciation ok");
		
		cookie.set();		            
		deepEqual(cookie.get(), session, "Get cookie ok");

        cookie.clear();
        equal(null, cookie.get());
        
        
        phrasea.setSession(null);
        document.cookie = 'phr_2345663=access_token=123456';
       
		console.log(document.cookie);

        cookie.load();
        
        console.log(cookie._phraseanet);
        equal(cookie._phraseanet.getSession(), {access_token: "123456"});
                        
        
        cookie.setRaw('access_token=56789');                        
        equal(cookie.get(), {access_token: "56789"});
                    
		
		var cookie2 = new Cookie(phrasea);
		
		cookie2.load();
		
		// Test load cookie dans un nouveau phrasea2/cookie2
		deepEqual(phrasea2.getSession(), session, "Load cookie with correct api key ok");
		
		
		var phrasea3 = new Phraseanet({
			apiKey: "123",
			domain: ""
		});
		
		var cookie3 = new Cookie(phrasea3);
		
		cookie3.load();
		
		// Test load cookie dans un nouveau phrasea3/cookie3 => ne doit pas fonctionner
		deepEqual(phrasea3.getSession(), {}, "Load cookie with wrong api key ok");
		
		cookie.clear();
		
		// Test clear cookie
		ok(document.cookie.indexOf('phr_2345663="access_token=toto"') == -1, "Clear cookie ok");
			
		});
		
    });
    
    </script>
  </head>
  <body>
    <h1 id="qunit-header">Phraseanet.JS</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
  </body>
</html>
